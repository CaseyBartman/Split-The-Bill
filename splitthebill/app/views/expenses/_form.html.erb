<%= form_with(model: [@trip, expense]) do |form| %>
  <% if expense.errors.any? %>
    <div style="color: red">
      <h2><%= pluralize(expense.errors.count, "error") %> prohibited this expense from being saved:</h2>
      <ul>
        <% expense.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- Trip Selection (already pre-populated in controller) -->
  <div>
    <%= form.label :trip_id, "Trip", style: "display: block" %>
    <%= form.text_field :trip_id, value: @trip.name, readonly: true %>
  </div>

  <div>
    <%= form.label :name, style: "display: block" %>
    <%= form.text_field :name %>
  </div>

  <div>
    <%= form.label :expense_type %>
    <%= form.select :expense_type, ["Food", "Gas", "Lodging", "Entertainment"], prompt: "Select a category" %>
  </div>

  <div>
    <%= form.label :amount, style: "display: block" %>
    <%= form.text_field :amount %>
  </div>

  <!-- Payer Selection-->
  <div>
    <%= form.label :payer_id, "Who Paid?" %>
    <%= form.collection_select :payer_id, @participants.map(&:user), :id, :name, prompt: "Select a Payer" %>
  </div>

  <div>
    <%= form.label :date, style: "display: block" %>
    <%= form.date_field :date %>
  </div>

    <!-- Cool trick! Can change the text of the button depending on if we are editing or making a new expense!-->
  <div>
    <%= form.submit expense.new_record? ? "Create Expense" : "Save Changes" %>
  </div>

  <!-- Hack to fix url generation error with edit -->
  <%= form.hidden_field :trip_id, value: @trip.id %> 
  
<h3>Participants' Contributions</h3>

  <!-- For the new expense (create) -->
  <% if @expense.new_record? %>
<%= form.fields_for :contributions do |contribution_fields| %>
    <div>
      <%= contribution_fields.label :amount, "#{contribution_fields.object.user.name}" %>
      <%= contribution_fields.hidden_field :user_id %>
      <%= contribution_fields.text_field :amount %>
      <%= contribution_fields.check_box :paid %>
    </div>
  <% end %>

  <!-- For the edit (update) view! -->
  <% else %>
  <% already_processed = [] %>
    <%= form.fields_for :contributions do |contribution_fields| %>
      <% @participants.each do |participant| %> 
      <% contribution = @expense.contributions.find { |c| c.user_id == participant.user.id } %>
      <% if already_processed.include?(contribution.id) %>
        <% break %> <!-- Exit the loop once we've seen this contribution -->
      <% else %>
        <!-- Add the contribution.id to the already_processed array -->
        <% already_processed << contribution.id %>
      <% end %>
      <!-- Debugging statement to print out the details of the current contribution -->
          <%= "DEBUG: Contribution ID: #{contribution.id}, User: #{contribution.user.name}, Amount: #{contribution.amount}, Paid: #{contribution.paid}" %>
          
        <div>
          <%= contribution_fields.label :amount, "#{contribution.user.name}" %>
          <%= contribution_fields.hidden_field :id, value: contribution.id %> <!-- This makes sure Rails knows it's an existing contribution -->
          <%= contribution_fields.hidden_field :user_id, value: contribution.user.id %>
          <%= contribution_fields.text_field :amount, value: contribution.amount %>
          <%= contribution_fields.check_box :paid, checked: contribution.paid %>
        </div>
      <% end %>
    <!-- <% end %> -->
  <% end %>
<% end %>